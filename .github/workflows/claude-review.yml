name: Claude Code Review

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  issue_comment:
    types:
      - created

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number }}"
  cancel-in-progress: true

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_code_oauth_token }}
          claude_args: "--allowedTools 'Bash(gh:*),Bash(git:*),Read,Glob,Grep'"
          prompt: |
            Act as a senior full-stack developer helping a junior developer.

            Review PR #${{ github.event.pull_request.number }} and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - React and JavaScript/TypeScript patterns
            - Any security concerns
            - Suggestions for improvement

            ## Steps to follow:

            1. Use `gh pr diff ${{ github.event.pull_request.number }}` to see the changes.

            2. Use `gh pr view ${{ github.event.pull_request.number }} --json files` to get the list of changed files.

            3. For inline comments on specific lines, use this command for each comment:
               ```
               gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments \
                 -f body="Your comment here" \
                 -f path="path/to/file.js" \
                 -f commit_id="$(gh pr view ${{ github.event.pull_request.number }} --json headRefOid -q .headRefOid)" \
                 -F line=<line_number> \
                 -f side="RIGHT"
               ```
               Note: line is the line number in the new version of the file (shown with + in the diff).

            4. After adding inline comments, submit a summary review using:
               ```
               gh pr review ${{ github.event.pull_request.number }} --comment --body "Your summary here"
               ```
               The summary should include:
               - Brief overview of the changes
               - Key findings (if any issues found)
               - Overall assessment

            Be constructive and specific in your feedback. Focus on the most important issues first.
            Be to the point and short in your explanations. Never use emojis.
            If the code looks good with no significant issues, say so briefly in the summary.
